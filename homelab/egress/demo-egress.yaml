# demo-egress-clean.yaml
# ----------------------
# 1) Namespaces
apiVersion: v1
kind: Namespace
metadata:
  name: mesh-ns
  labels:
    istio-injection: enabled
---
apiVersion: v1
kind: Namespace
metadata:
  name: external-ns
---
# 2) hello1 - hashicorp/http-echo (internal target)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hello1
  namespace: external-ns
spec:
  replicas: 1
  selector:
    matchLabels:
      app: hello1
  template:
    metadata:
      labels:
        app: hello1
    spec:
      containers:
      - name: http-echo
        image: hashicorp/http-echo:0.2.3
        args: ["-text=hello-from-hello1", "-listen=:8080"]
        ports:
        - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: hello1
  namespace: external-ns
spec:
  selector:
    app: hello1
  ports:
  - port: 8080
    targetPort: 8080
    name: http
---
# 3) hello2 - google sample hello-app
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hello2
  namespace: external-ns
spec:
  replicas: 1
  selector:
    matchLabels:
      app: hello2
  template:
    metadata:
      labels:
        app: hello2
    spec:
      containers:
      - name: hello
        image: gcr.io/google-samples/hello-app:1.0
        ports:
        - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: hello2
  namespace: external-ns
spec:
  selector:
    app: hello2
  ports:
  - port: 8080
    targetPort: 8080
    name: http
---
# 4) client in mesh-ns (sidecar-injected) - use curl image
apiVersion: apps/v1
kind: Deployment
metadata:
  name: client
  namespace: mesh-ns
spec:
  replicas: 1
  selector:
    matchLabels:
      app: client
  template:
    metadata:
      labels:
        app: client
    spec:
      containers:
      - name: curl
        image: curlimages/curl:8.1.2
        command: ["/bin/sleep","infinity"]
---
# 5) Egress Gateway - Gateway object selecting istio-egressgateway
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: egress-gw-for-externalns
  namespace: istio-system
spec:
  selector:
    istio: egressgateway   # selects the egressgateway pods (default istio install)
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - hello1.external-ns.svc.cluster.local
    - hello2.external-ns.svc.cluster.local
---
# 6) Egress-side VirtualService bound to the Gateway (path-based)
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: egress-to-internal-services
  namespace: istio-system
spec:
  hosts:
  - hello1.external-ns.svc.cluster.local
  - hello2.external-ns.svc.cluster.local
  gateways:
  - egress-gw-for-externalns
  http:
  - match:
    - uri:
        prefix: /h1
    route:
    - destination:
        host: hello1.external-ns.svc.cluster.local
        port:
          number: 8080
  - match:
    - uri:
        prefix: /h2
    route:
    - destination:
        host: hello2.external-ns.svc.cluster.local
        port:
          number: 8080
---
# 7) Mesh-side VirtualService in mesh-ns routing both destinations to the istio-egressgateway service
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: route-externalns-to-egress
  namespace: mesh-ns
spec:
  hosts:
  - hello1.external-ns.svc.cluster.local
  - hello2.external-ns.svc.cluster.local
  http:
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        host: istio-egressgateway.istio-system.svc.cluster.local
        port:
          number: 80
